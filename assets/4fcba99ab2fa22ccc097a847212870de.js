((function(){if(!Element.prototype.matches){Element.prototype.matches=Element.prototype.msMatchesSelector||Element.prototype.webkitMatchesSelector;}
var findAncestor=function(el,selector){while((el=el.parentElement)&&!((el.matches||el.matchesSelector).call(el,selector))){}
return el;};var fields=document.querySelectorAll('input[name="searchfield"][data-search-input]');Array.prototype.forEach.call(fields,function(field){var form=findAncestor(field,'form[data-simplesearch-form]'),min=field.getAttribute('data-min')||false,location=field.getAttribute('data-search-input'),separator=field.getAttribute('data-search-separator');if(min){var invalid=field.getAttribute('data-search-invalid');field.addEventListener('keydown',function(){field.setCustomValidity(field.value.length>=min?'':invalid);});}
form.addEventListener('submit',function(event){event.preventDefault();if(field.checkValidity()){window.location.href=location+separator+field.value;}});});})());;
const isTouch=('ontouchstart'in window)||(navigator.maxTouchPoints>0);function triggerHaptic(type='light'){if(!navigator.vibrate)return;switch(type){case'error':navigator.vibrate([50,50,50]);break;case'medium':navigator.vibrate(30);break;case'light':default:navigator.vibrate(10);break;}}
const ecoModeKey='theme_eco_mode';const focusModeKey='theme_focus_mode';const bionicModeKey='theme_bionic_mode';let sessionState=[];const rollbackLimit=10;function captureState(){const state={eco:document.body.classList.contains('eco-mode'),focus:document.body.classList.contains('focus-mode'),bionic:document.body.classList.contains('bionic-mode')};sessionState.push(state);if(sessionState.length>rollbackLimit)sessionState.shift();showRollbackUI();}
function showRollbackUI(){let rollbackBtn=document.getElementById('session-rollback');if(!rollbackBtn&&sessionState.length>1){rollbackBtn=document.createElement('button');rollbackBtn.id='session-rollback';rollbackBtn.className='layer-floating glass-panel squishy';rollbackBtn.innerHTML='<span>â†º Rollback State</span>';rollbackBtn.style.bottom='80px';rollbackBtn.style.right='20px';rollbackBtn.style.padding='10px 15px';rollbackBtn.style.borderRadius='50px';rollbackBtn.style.fontSize='0.8rem';document.body.appendChild(rollbackBtn);rollbackBtn.addEventListener('click',rollbackSession);}else if(rollbackBtn&&sessionState.length<=1){rollbackBtn.remove();}}
function rollbackSession(){if(sessionState.length<=1)return;sessionState.pop();const prevState=sessionState[sessionState.length-1];triggerHaptic('medium');setEcoMode(prevState.eco,false);setFocusMode(prevState.focus,false);setBionicMode(prevState.bionic,false);showRollbackUI();}
function setBionicMode(enabled,record=true){if(enabled){document.body.classList.add('bionic-mode');localStorage.setItem(bionicModeKey,'true');applyBionicReading();}else{document.body.classList.remove('bionic-mode');localStorage.setItem(bionicModeKey,'false');removeBionicReading();}
if(record)captureState();}
function applyBionicReading(){const textNodes=[];const walk=document.createTreeWalker(document.getElementById('page-wrapper'),NodeFilter.SHOW_TEXT,null,false);let node;while(node=walk.nextNode()){if(node.parentElement.tagName!=='SCRIPT'&&node.parentElement.tagName!=='STYLE'&&node.textContent.trim().length>0){textNodes.push(node);}}
textNodes.forEach(node=>{const span=document.createElement('span');span.className='bionic-text-wrapper';const words=node.textContent.split(/\s+/);span.innerHTML=words.map(word=>{if(word.length<=1)return word;const mid=Math.ceil(word.length / 2);return`<b>${word.substring(0, mid)}</b>${word.substring(mid)}`;}).join(' ');if(node.parentNode){node.parentNode.replaceChild(span,node);}});}
function removeBionicReading(){document.querySelectorAll('.bionic-text-wrapper').forEach(wrapper=>{const textNode=document.createTextNode(wrapper.textContent);wrapper.parentNode.replaceChild(textNode,wrapper);});}
function setEcoMode(enabled,record=true){if(enabled){document.body.classList.add('eco-mode');localStorage.setItem(ecoModeKey,'true');}else{document.body.classList.remove('eco-mode');localStorage.setItem(ecoModeKey,'false');}
if(record)captureState();}
function setFocusMode(enabled,record=true){if(enabled){document.body.classList.add('focus-mode');localStorage.setItem(focusModeKey,'true');}else{document.body.classList.remove('focus-mode');localStorage.setItem(focusModeKey,'false');}
if(record)captureState();}
if(localStorage.getItem(ecoModeKey)==='true')setEcoMode(true,false);if(localStorage.getItem(focusModeKey)==='true')setFocusMode(true,false);if(localStorage.getItem(bionicModeKey)==='true')setBionicMode(true,false);captureState();function initDoodleEngine(){const container=document.getElementById('doodle-container');if(!container)return;const doodleTypes=['<circle cx="50" cy="50" r="40" />','<rect x="20" y="20" width="60" height="60" />','<path d="M10 80 Q 50 10 90 80" />','<path d="M20 20 L80 80 M80 20 L20 80" />'];for(let i=0;i<15;i++){const doodle=document.createElement('div');doodle.className='doodle';doodle.innerHTML=`<svg viewBox="0 0 100 100">${doodleTypes[Math.floor(Math.random() * doodleTypes.length)]}</svg>`;doodle.style.top=Math.random()*100+'vh';doodle.style.left=Math.random()*100+'vw';doodle.style.setProperty('--rotation',Math.random()*360+'deg');doodle.style.setProperty('--opacity',(Math.random()*0.5+0.1));container.appendChild(doodle);}}
function scrollHeader(){const header=document.getElementById('header');if(!header)return;if(window.scrollY>75){header.classList.add('scrolled');header.classList.add('glass-panel');}else{header.classList.remove('scrolled');header.classList.remove('glass-panel');}}
function parallaxBackground(){const parallax=document.querySelector('.parallax');if(parallax){parallax.style.backgroundPositionY=(window.scrollY*0.3)+'px';}}
document.addEventListener('DOMContentLoaded',()=>{scrollHeader();const settings=window.themeSettings||{ai_disclosure:true,focus_mode:false,doodle_engine:true};if(settings.doodle_engine){initDoodleEngine();}
const initAIChatbot=()=>{let dragStartX=0;let dragStartY=0;let initialBtnLeft=0;let initialBtnTop=0;let isDragging=false;const aiPosKey='ai_chat_pos';const isAIEnabled=localStorage.getItem('ai_assistant_enabled')!=='false';const aiToggleBtn=document.createElement('button');aiToggleBtn.id='ai-assistant-toggle';aiToggleBtn.className='ai-toggle-btn';aiToggleBtn.innerHTML=isAIEnabled?'ðŸ¤– Hide AI':'ðŸ¤– Show AI';aiToggleBtn.title=isAIEnabled?'Hide AI Assistant':'Show AI Assistant';aiToggleBtn.style.cssText=`
            position: fixed;
            top: 80px;
            right: 20px;
            padding: 8px 16px;
            background: rgba(255, 255, 255, 0.9);
            border: 1px solid rgba(0, 0, 0, 0.1);
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.85rem;
            font-weight: 600;
            z-index: 999;
            backdrop-filter: blur(10px);
            transition: all 0.3s ease;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        `;const chatBtn=document.createElement('button');chatBtn.id='ai-chat-toggle';chatBtn.className='layer-floating glass-panel squishy';chatBtn.innerHTML='<span>âœ¨ AI Assistant</span>';chatBtn.style.bottom='20px';chatBtn.style.left='20px';chatBtn.style.padding='12px 20px';chatBtn.style.borderRadius='50px';chatBtn.style.display=isAIEnabled?'block':'none';const chatPanel=document.createElement('div');chatPanel.id='ai-chat-panel';chatPanel.className='glass-panel';chatPanel.style.position='fixed';chatPanel.style.bottom='80px';chatPanel.style.left='20px';chatPanel.style.width='300px';chatPanel.style.height='400px';chatPanel.style.display='none';chatPanel.style.flexDirection='column';chatPanel.style.zIndex='1000';chatPanel.style.padding='15px';chatPanel.style.borderRadius='15px';chatPanel.innerHTML=`
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;">
                <h4 style="margin:0">AI Knowledge Base</h4>
                <button id="close-ai-chat" style="background:none;border:none;cursor:pointer;font-size:1.2rem">Ã—</button>
            </div>
            <div id="ai-chat-messages" style="flex-grow:1;overflow-y:auto;font-size:0.9rem;margin-bottom:10px;">
                <p><em>Ask me anything about this site... (RAG interface stub)</em></p>
            </div>
            <div style="display:flex;gap:5px;">
                <input type="text" placeholder="Type a message..." style="flex-grow:1;padding:5px;border-radius:5px;border:1px solid rgba(0,0,0,0.1)">
                <button class="btn" style="padding:5px 10px;">Send</button>
            </div>
        `;document.body.appendChild(aiToggleBtn);if(isAIEnabled){document.body.appendChild(chatBtn);document.body.appendChild(chatPanel);}
const toggleChat=()=>{const currentState=localStorage.getItem('ai_assistant_enabled')!=='false';const newState=!currentState;localStorage.setItem('ai_assistant_enabled',newState);if(newState){aiToggleBtn.innerHTML='ðŸ¤– Hide AI';aiToggleBtn.title='Hide AI Assistant';chatBtn.style.display='block';document.body.appendChild(chatBtn);document.body.appendChild(chatPanel);setTimeout(()=>{chatBtn.style.opacity='1';chatBtn.style.transform='translateY(0)';},10);}else{aiToggleBtn.innerHTML='ðŸ¤– Show AI';aiToggleBtn.title='Show AI Assistant';chatBtn.style.opacity='0';chatBtn.style.transform='translateY(20px)';chatPanel.style.display='none';setTimeout(()=>{chatBtn.style.display='none';if(chatBtn.parentNode)chatBtn.parentNode.removeChild(chatBtn);if(chatPanel.parentNode)chatPanel.parentNode.removeChild(chatPanel);},300);}
triggerHaptic('light');const rect=chatBtn.getBoundingClientRect();initialBtnLeft=rect.left;initialBtnTop=rect.top;const onDragMove=(moveEvent)=>{const currentX=moveEvent.type==='touchmove'?moveEvent.touches[0].clientX:moveEvent.clientX;const currentY=moveEvent.type==='touchmove'?moveEvent.touches[0].clientY:moveEvent.clientY;const dx=currentX-dragStartX;const dy=currentY-dragStartY;if(Math.abs(dx)>5||Math.abs(dy)>5){isDragging=true;chatBtn.style.bottom='auto';chatBtn.style.left=(initialBtnLeft+dx)+'px';chatBtn.style.top=(initialBtnTop+dy)+'px';chatBtn.style.cursor='grabbing';chatPanel.style.display='none';}};const onDragEnd=()=>{chatBtn.style.cursor='move';document.removeEventListener('mousemove',onDragMove);document.removeEventListener('mouseup',onDragEnd);document.removeEventListener('touchmove',onDragMove);document.removeEventListener('touchend',onDragEnd);if(isDragging){const rect=chatBtn.getBoundingClientRect();localStorage.setItem(aiPosKey,JSON.stringify({x:rect.left,y:rect.top}));}else{toggleChat();}};document.addEventListener('touchmove',onDragMove,{passive:false});document.addEventListener('touchend',onDragEnd);};aiToggleBtn.addEventListener('click',toggleChat);const onDragStart=(e)=>{isDragging=false;dragStartX=e.type==='touchstart'?e.touches[0].clientX:e.clientX;dragStartY=e.type==='touchstart'?e.touches[0].clientY:e.clientY;};chatBtn.style.cursor='move';chatBtn.addEventListener('mousedown',onDragStart);chatBtn.addEventListener('touchstart',onDragStart,{passive:false});chatPanel.querySelector('#close-ai-chat').addEventListener('click',()=>{chatPanel.style.display='none';});};if(settings.ai_assistant){initAIChatbot();}
if(settings.focus_mode){setFocusMode(true,false);}
if(!isTouch){window.addEventListener('scroll',()=>{requestAnimationFrame(()=>{scrollHeader();parallaxBackground();});},{passive:true});}else{window.addEventListener('touchmove',()=>{requestAnimationFrame(scrollHeader);},{passive:true});}
const toStart=document.getElementById('to-start');if(toStart){toStart.addEventListener('click',(e)=>{e.preventDefault();const start=document.getElementById('start');if(start){const headerOffset=45;const elementPosition=start.getBoundingClientRect().top;const offsetPosition=elementPosition+window.scrollY-headerOffset;window.scrollTo({top:offsetPosition,behavior:'smooth'});}});}
const toTop=document.getElementById('to-top');if(toTop){toTop.addEventListener('click',(e)=>{e.preventDefault();window.scrollTo({top:0,behavior:'smooth'});});}
const toggle=document.getElementById('toggle');const overlay=document.getElementById('overlay');const body=document.body;if(toggle){toggle.addEventListener('click',()=>{triggerHaptic('light');toggle.classList.toggle('active');if(overlay)overlay.classList.toggle('open');body.classList.toggle('mobile-nav-open');});}
const ecoToggle=document.getElementById('eco-toggle');if(ecoToggle){ecoToggle.addEventListener('click',(e)=>{e.preventDefault();triggerHaptic('medium');const isEco=document.body.classList.contains('eco-mode');setEcoMode(!isEco);});}
const focusToggle=document.getElementById('focus-toggle');if(focusToggle){focusToggle.addEventListener('click',(e)=>{e.preventDefault();triggerHaptic('medium');const isFocus=document.body.classList.contains('focus-mode');setFocusMode(!isFocus);});}
const bionicToggle=document.getElementById('bionic-toggle');if(bionicToggle){bionicToggle.addEventListener('click',(e)=>{e.preventDefault();triggerHaptic('medium');const isBionic=document.body.classList.contains('bionic-mode');setBionicMode(!isBionic);});}
document.querySelectorAll('.btn, .donate-btn, .social-btn').forEach(btn=>{btn.classList.add('squishy');btn.addEventListener('click',()=>triggerHaptic('light'));});if(navigator.xr){navigator.xr.isSessionSupported('immersive-vr').then((supported)=>{if(supported){document.body.classList.add('xr-supported');const xrButton=document.createElement('button');xrButton.id='xr-entry-button';xrButton.className='layer-floating glass-panel squishy';xrButton.innerHTML='<span>ðŸ¥½ Enter Spatial Mode</span>';xrButton.setAttribute('aria-label','Enter WebXR Immersive Experience');xrButton.style.bottom='20px';xrButton.style.right='20px';xrButton.style.padding='12px 20px';xrButton.style.borderRadius='50px';xrButton.style.cursor='pointer';xrButton.style.display='flex';xrButton.style.alignItems='center';xrButton.style.gap='8px';document.body.appendChild(xrButton);xrButton.addEventListener('click',()=>{triggerHaptic('medium');console.log('WebXR Session Requested');alert('WebXR Mode Requested. (Hardware placeholder)');});}});}
const speculationScript=document.createElement('script');speculationScript.type='speculationrules';document.head.appendChild(speculationScript);const updateSpeculationRules=(urls)=>{if(HTMLScriptElement.supports&&HTMLScriptElement.supports('speculationrules')){const rules={prefetch:[{source:'list',urls:urls}],prerender:[{source:'list',urls:urls,score:0.5}]};speculationScript.textContent=JSON.stringify(rules);}};document.querySelectorAll('a').forEach(link=>{link.addEventListener('mouseenter',()=>{if(!document.body.classList.contains('eco-mode')&&!document.body.classList.contains('focus-mode')){link.classList.add('gaze-aware');}
const href=link.getAttribute('href');if(href&&href.startsWith('/')&&!href.startsWith('#')){updateSpeculationRules([href]);}});link.addEventListener('mouseleave',()=>{link.classList.remove('gaze-aware');});});const trees=document.querySelectorAll('.tree');trees.forEach(tree=>{const parents=tree.querySelectorAll('li:has(ul)');parents.forEach(parent=>{const link=parent.querySelector('a');const submenu=parent.querySelector('ul');if(link&&submenu){if(link.classList.contains('active')||submenu.querySelector('.active')){parent.classList.add('open');}
const toggle=document.createElement('span');toggle.className='tree-toggle';toggle.innerHTML='+';toggle.style.cursor='pointer';toggle.style.float='right';toggle.style.marginLeft='10px';link.appendChild(toggle);toggle.addEventListener('click',(e)=>{e.preventDefault();e.stopPropagation();parent.classList.toggle('open');toggle.innerHTML=parent.classList.contains('open')?'-':'+';});}});});const newsletterForm=document.querySelector('.footer-form');if(newsletterForm){newsletterForm.addEventListener('submit',(e)=>{triggerHaptic('medium');});}
if('PerformanceObserver'in window){const vitalsObserver=new PerformanceObserver((list)=>{for(const entry of list.getEntries()){console.log(`[Performance] ${entry.name}:`,entry.startTime.toFixed(2)+'ms');const vitals=JSON.parse(sessionStorage.getItem('core_web_vitals')||'{}');vitals[entry.name]=entry.startTime;sessionStorage.setItem('core_web_vitals',JSON.stringify(vitals));}});vitalsObserver.observe({entryTypes:['paint','largest-contentful-paint']});if('PerformanceEventTiming'in window){const inpObserver=new PerformanceObserver((list)=>{for(const entry of list.getEntries()){if(entry.duration>200){console.warn(`[Performance] Slow interaction detected: ${entry.duration.toFixed(2)}ms`);}}});inpObserver.observe({type:'event',buffered:true});}}
if(window.DeviceOrientationEvent&&!isTouch){const requestOrientationPermission=()=>{if(typeof DeviceOrientationEvent.requestPermission==='function'){DeviceOrientationEvent.requestPermission().then(permissionState=>{if(permissionState==='granted'){enableMagicWindow();}}).catch(console.error);}else{enableMagicWindow();}};const enableMagicWindow=()=>{window.addEventListener('deviceorientation',(e)=>{if(!document.body.classList.contains('eco-mode')){const tilt=e.beta;const turn=e.gamma;document.querySelectorAll('.parallax-3d, .hero').forEach(el=>{const intensity=0.05;el.style.transform=`
                            perspective(1000px)
                            rotateX(${tilt * intensity}deg) 
                            rotateY(${turn * intensity}deg)
                        `;});}},{passive:true});};if(typeof DeviceOrientationEvent.requestPermission!=='function'){enableMagicWindow();}else{const magicWindowBtn=document.createElement('button');magicWindowBtn.textContent='ðŸŽ¯ Enable 3D View';magicWindowBtn.className='btn btn-sm layer-floating glass-panel';magicWindowBtn.style.cssText='position:fixed;top:80px;right:20px;z-index:100;';magicWindowBtn.addEventListener('click',()=>{requestOrientationPermission();magicWindowBtn.remove();});if(window.innerWidth<768){document.body.appendChild(magicWindowBtn);}}}});;
