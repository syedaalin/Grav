{# 
    NUR-UL-HUDA GLOBAL MACROS
    -------------------------
    Blueprint: [navigation.blueprint.md](file:///Users/syedaalin/Documents/Grav/user/themes/nur-ul-huda/blueprints/docs/navigation.blueprint.md)
#}
{% macro nav_loop(page, mobile) %}
	{% import _self as macros %}
	{% for p in page.children.visible %}
		{% if not p.home %}
			{% set active_page = (p.active or p.activeChild) ? 'active' : '' %}
			{% set has_children = p.children.visible.count > 0 %}

			{# Parent Item Container #}
			{# Logic: khums is always desktop-only. services/ask/donate are hidden on mobile ONLY if called from desktop loop? 
						               Actually, let's simplify: if it's khums, it's desktop-only. #}
			{% set is_khums = p.slug == 'khums-calculator' %}
			{% set hide_on_mobile = is_khums or ((not mobile) and (p.slug in ['services', 'ask', 'donate'])) %}
				<li class="nav-item {{ hide_on_mobile ? 'desktop-only' : '' }}"> {% if mobile and has_children %}
					{# Mobile Split View: Link + Toggle #}
					<div class="flex-between">
						<a href="{{ p.url }}" class="nav-link-mobile {{ active_page }}">
							{{ p.menu }}
						</a>
						<button type="button" class="mobile-submenu-toggle {{ active_page }}" aria-expanded="{{ active_page == 'active' ? 'true' : 'false' }}" aria-label="Toggle submenu">
							<i class="la la-angle-down"></i>
						</button>
					</div>
				{% else %}
					{# Desktop or Mobile Leaf Item #}
					<a href="{{ p.url }}" class="nav-link {{ active_page }}" {% if p.active or p.activeChild %} aria-current="page" {% endif %}>

						<span>{{ p.menu }}</span>

						{% if has_children %}
							<i class="la la-angle-down" aria-hidden="true"></i>
						{% endif %}
					</a>
				{% endif %}

				{% if has_children %}
					{% if mobile %}
						{# Mobile Submenu: Always rendered, Hidden by default unless active #}
						<ul class="mobile-submenu {{ active_page == 'active' ? '' : 'hidden' }}">
							{% for sub in p.children.visible %}
								<li>
									<a href="{{ sub.url }}" class="{{ sub.active ? 'active' : '' }}">
										{{ sub.menu }}
									</a>
								</li>
							{% endfor %}
						</ul>
					{% else %}
						{# Desktop Submenu: Absolute, Hover-based #}
						<ul class="desktop-submenu">
							{% for sub in p.children.visible %}
								<li>
									<a href="{{ sub.url }}" {% if sub.active %} aria-current="page" {% endif %}>
										{{ sub.menu }}
									</a>
								</li>
							{% endfor %}
						</ul>
					{% endif %}
				{% endif %}
			</li>
		{% endif %}
	{% endfor %}
{% endmacro %}
