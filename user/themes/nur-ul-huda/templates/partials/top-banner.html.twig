
{% set _top_banner_enabled = theme_var('top_banner_enabled') %}
{% if _top_banner_enabled is null ? true : _top_banner_enabled %}
    {# Logic Hoisting #}
    {% set announcement_text = theme_var('top_banner_announcement_text') %}
    {% set announcement_expires = theme_var('top_banner_announcement_expires') %}
    {% set show_announcement = theme_var('top_banner_announcement_enabled') and announcement_text and (not announcement_expires or date(announcement_expires) > date('now')) %}
    {% set text_dir = grav.language.getDirection() ?: 'ltr' %}
    
    {# Color Logic - Using oklch for broader gamut and better accessibility #}
    {% set default_bg = theme_var('top_banner_bg_color')|default('oklch(0.2 0.02 260)') %}
    {% set default_text = theme_var('top_banner_text_color')|default('oklch(0.85 0.15 85)') %}
    {% set announce_bg = theme_var('top_banner_announcement_bg_color')|default('oklch(0.5 0.25 25)') %}
    {% set announce_text = theme_var('top_banner_announcement_text_color')|default('oklch(0.98 0.01 260)') %}

    {% set current_bg = show_announcement ? announce_bg : default_bg %}
    {% set current_text = show_announcement ? announce_text : default_text %}
    
    {# Standardize color strings #}
    {% set current_bg_style = current_bg matches '/^var\\(/i' or current_bg matches '/^oklch/i' ? current_bg : 'oklch(from ' ~ current_bg ~ ' L C H)' %}
    {% set current_text_style = current_text matches '/^var\\(/i' or current_text matches '/^oklch/i' ? current_text : 'oklch(from ' ~ current_text ~ ' L C H)' %}

<div id="top-banner-utility-bar" 
     class="top-banner" 
     style="background-color: {{ current_bg_style }}; color: {{ current_text_style }}; box-shadow: 0 4px 24px -2px oklch(from {{ current_bg_style }} L C H / 0.5);" 
     dir="{{ text_dir }}"
     role="complementary"
     aria-label="Utility Bar">
    
    <div class="top-banner-inner">
        
        {% if show_announcement %}
            {# === EXCLUSIVE ANNOUNCEMENT MODE === #}
            <div class="top-banner-announcement" role="alert" aria-live="assertive">
                <div class="announcement-marquee-container">
                    <div class="announcement-marquee">
                        {{ announcement_text }}
                    </div>
                </div>
            </div>

        {% else %}
            {# === STANDARD WIDGET MODE === #}
            <div class="top-banner-widgets">
                
                {# 1. Gregorian Date #}
                {% if theme_var('top_banner_show_dates')|default(true) %}
                    <div class="banner-widget">
                        <time id="gregorian-date" class="banner-date" datetime="{{ 'now'|date('Y-m-d') }}">
                            {{ "now"|date("D, M j") }}<span class="year-responsive">{{ "now"|date(", Y") }}</span>
                        </time>
                    </div>
                {% endif %}

                {# 2. Prayer Ticker (Center) #}
                {% if theme_var('top_banner_show_prayer_ticker')|default(true) %}
                    <div class="banner-widget" role="timer" aria-live="polite">
                        <span class="banner-prayer-name" id="next-prayer-name">Maghrib</span>
                        <time class="banner-countdown" id="prayer-countdown">00:00</time>
                    </div>
                {% endif %}

                {# 3. Hijri Date (Right) #}
                {% if theme_var('top_banner_show_dates')|default(true) %}
                    <div class="banner-widget">
                        <span id="hijri-date" class="banner-date" aria-live="polite">Loading...</span>
                    </div>
                {% endif %}
            </div>
            
        {% endif %}

    </div>
</div>
{% endif %}
