{% set direction = theme_var('direction')|default('ltr') %}
{% set language = theme_var('language')|default(grav.language.getActive ?: grav.config.site.default_lang ?: 'en') %}
{% set typography = theme_var('typography')|default('font-sans') %}
{% set body_classes = body_class(['header-fixed', 'header-animated', 'header-dark', 'header-transparent', direction, typography]) %}
{% set grid_size = theme_var('grid-size') %}
{% set compress = theme_var('production-mode') ? '.min.css' : '.css' %}
{% set top_banner_color = theme_var('top_banner_bg_color')|default('oklch(0.2 0.02 260)') %}

{# Dynamic Theme Colors Manager - DEPRECATED/MOVED TO PHP #}
{# Usage: dynamic_styles is passed from nur-ul-huda.php #}

{% use 'blocks/base.html.twig' %}
<!DOCTYPE html>
<html lang="{{ language }}" dir="{{ direction }}" style="--top-banner-color: {{ top_banner_color }}; {{ dynamic_styles|raw }}; --font-heading: {{ theme_fonts.heading|raw }}; --font-body: {{ theme_fonts.body|raw }};">
	<head>
		{% if theme_fonts.custom_css %}
			<style>
				{{theme_fonts.custom_css|raw}}</style>
		{% endif %}
		{# Local Fonts #}
		{% block head deferred %}
			<meta charset="utf-8"/>
			<title>
				{% if page.title %}
					{{ page.title|e('html') }}
					|
				{% endif %}
				{{ site.title|e('html') }}</title>

			<meta http-equiv="X-UA-Compatible" content="IE=edge">
			<meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no">
			{% if theme_var('production-mode') %}
				<meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval' https://cdn.snipcart.com https://api.aladhan.com; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com https://cdn.snipcart.com; font-src 'self' https://fonts.gstatic.com data:; img-src 'self' data: https://cdn.snipcart.com; connect-src 'self' https://api.aladhan.com https://cdn.snipcart.com; frame-src 'self' https://cdn.snipcart.com;">
			{% endif %}
			{% include 'partials/metadata.html.twig' ignore missing %}

			{% set logo_img = theme_var('custom_logo') ? media['theme://images/logo/' ~ (theme_var('custom_logo')|first).name] : null %}
			{% set favicon = logo_img ? logo_img.cropZoom(32, 32) : media['theme://images/favicon.png'] %}
			<link rel="icon" type="image/png" href="{{ favicon.url }}"/>
			<link rel="canonical" href="{{ page.url(true, true) }}"/>

			<link rel="manifest" href="{{ base_url }}/manifest">
			<meta name="theme-color" content="oklch(0.55 0.18 165)">
			<meta name="mobile-web-app-capable" content="yes">
			<meta name="apple-mobile-web-app-capable" content="yes">
			<meta name="apple-mobile-web-app-status-bar-style" content="default">
			<meta
			name="apple-mobile-web-app-title" content="{{ site.title }}">

			{# Service Worker Registration #}
			<script>
				if ('serviceWorker' in navigator) {
window.addEventListener('load', () => {
navigator.serviceWorker.register('{{ theme_url }}/sw.js').then((registration) => {
console.log('SW registered:', registration);
}).catch((error) => {
console.log('SW registration failed:', error);
});
});
}
			</script>


		{% endblock head %}

		{% block stylesheets %}
			{% do assets.addCss('theme://css/modern-vanilla.css') %}
			{% do assets.addCss('theme://css/line-awesome.min.css') %}
		{% endblock %}

		{% block javascripts %}
			{% do assets.addJs('jquery', 101) %}
			{% do assets.addJs('theme://js/modules/khums-calculator.js', {'priority': 100, 'group': 'bottom', 'type': 'module'}) %}
			{% do assets.addJs('theme://js/modules/ui.js', {'priority': 95, 'group': 'bottom', 'type': 'module'}) %}
			{% do assets.addJs('theme://js/modules/utils.js', 95) %}
			{% do assets.addJs('theme://js/modules/performance-monitor.js', 94) %}
			{% do assets.addJs('theme://js/modules/pull-refresh.js', 94) %}
			{% do assets.addJs('theme://js/modules/gallery.js', 93) %}
			{% do assets.addJs('theme://js/modules/high-contrast.js', 89) %}
			{% do assets.addJs('theme://js/modules/font-scaler.js', 89) %}
			{% do assets.addJs('theme://js/modules/bottom-banner.js', 89) %}
			{% do assets.addJs('theme://js/modules/prayer-times.js', 89) %}
			{% do assets.addJs('theme://js/modules/hijri-date.js', 89) %}
			{% do assets.addJs('theme://js/modules/adhan-player.js', 89) %}
			{% do assets.addJs('theme://js/modules/spiritual.js', 88) %}
		{% endblock %}

		{% block assets deferred %}
			{{ assets.css()|raw }}
			{{ assets.js()|raw }}
		{% endblock %}
	</head>
	<body
		id="top" class="{{ body_classes }} {{ dynamic_body_classes|join(' ') }}">
		{# ROOT DIAGNOSTIC - BASE TEMPLATE ENTRY #}
		<div id="root-debug-base" style="position: fixed; top: 40px; right: 0; background: orange; color: black; padding: 10px; z-index: 1000000; font-family: monospace; font-size: 14px; border: 2px solid black; font-weight: bold; pointer-events: none;">
			ROOT_BASE_LOADED | FILE: partials/base.html.twig
		</div>
		<div
			id="page-wrapper">
			{# Skip Link for Accessibility #}
			<a href="#start" class="skip-link">Skip to main content</a>

			{% block header %}
				{# Top Banner (FORCED INCLUSION FOR DEBUG) #}
				<div class="header-top-sticky" style="display: block !important; visibility: visible !important; opacity: 1 !important; height: auto !important; min-height: 2.75rem !important;">
					{% include 'partials/top-banner.html.twig' %}
				</div>

				{# Main Header (Smart Sticky, Z-50) #}
				<header id="header" class="header-main-sticky" role="banner">

					<div class="container container-px header-spacing">
						<nav
							class="header-nav" aria-label="Main navigation">

							{# ZONE A: Mobile Toggle / Desktop Logo #}
							<div
								class="header-zone-a">
								{# Mobile Toggle #}
								<button id="mobile-toggle" class="mobile-toggle" aria-label="Open navigation menu" aria-controls="mobile-overlay" aria-expanded="false">
									<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewbox="0 0 24 24" stroke-width="2.5" stroke="currentColor" class="icon-lg">
										<path stroke-linecap="round" stroke-linejoin="round" d="M3.75 6.75h16.5M3.75 12h16.5m-16.5 5.25h16.5"/>
									</svg>
								</button>

								{# Desktop Logo #}
								<div class="desktop-only logo-hover">
									{% include 'partials/logo.html.twig' %}
								</div>
							</div>

							{# ZONE B: Mobile Logo / Desktop Navigation #}
							<div
								class="header-zone-b">
								{# Mobile Logo (Centered) #}
								<div class="mobile-only logo-hover">
									{% include 'partials/logo.html.twig' with {mobile: true} %}
								</div>

								{# Desktop Navigation #}
								<nav id="desktop-nav" class="desktop-nav">
									{% block header_navigation %}
										{% include 'partials/navigation.html.twig' %}
									{% endblock %}
								</nav>
							</div>

							{# ZONE C: User Actions #}
							<div
								class="header-zone-c">

								{# Search Trigger #}
								<button id="search-trigger" class="icon-button desktop-only" aria-label="Open search">
									<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewbox="0 0 24 24" stroke-width="2.5" stroke="currentColor" class="icon-lg">
										<path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-5.197-5.197m0 0A7.5 7.5 0 105.196 5.196a7.5 7.5 0 0010.607 10.607z"/>
									</svg>
								</button>


								{# User Account #}
								{% if config.plugins.login.enabled and grav.user.username %}
									<a href="{{ url('theme://dashboard') }}" class="btn-dashboard desktop-only" aria-label="Go to Dashboard">
										<span>Dashboard</span>
									</a>
								{% else %}
									{% set login_url = theme_var('moodle_url') ? theme_var('moodle_url') ~ '/login' : url('theme://login') %}
									<a href="{{ login_url }}" class="btn-login desktop-only" aria-label="Log in to your account">
										Login
									</a>
								{% endif %}
							</div>
						</nav>
					</div>
				</header>

				{# Mobile Off-Canvas Menu #}
				{# Mobile Off-Canvas Menu #}
				<div
					id="mobile-menu-wrapper" class="mobile-menu-overlay" role="dialog" aria-modal="true" aria-label="Mobile Navigation">

					{# Backdrop #}
					<div id="mobile-backdrop" class="mobile-menu-backdrop"></div>

					{# Sidebar #}
					<div id="mobile-sidebar" class="mobile-sidebar">

						<div
							class="mobile-sidebar-inner">
							{# Overlay Content #}
							<div
								class="mobile-sidebar-content">
								{# Mobile Nav #}
								<nav class="mobile-nav stack-s animate-fade-in-up delay-100">
									{% include 'partials/navigation.html.twig' with {mobile: true} %}
								</nav>
							</div>

							{# Overlay Footer #}
							<div class="mobile-sidebar-footer animate-fade-in-up delay-200">
								<h4 class="mobile-footer-title">Follow Our Journey</h4>
								<div class="social-icons-grid">
									{% for platform in ['facebook', 'twitter', 'instagram', 'youtube'] %}
										{% set social_url = theme_var('social_' ~ platform) %}
										{% if social_url %}
											<a href="{{ social_url }}" target="_blank" class="social-icon" aria-label="{{ platform|capitalize }}">
												<i class="lab la-{{ platform == 'facebook' ? 'facebook-f' : platform }}"></i>
											</a>
										{% endif %}
									{% endfor %}
								</div>
							</div>
						</div>
					</div>
				</div>
			{% endblock %}


			{% block hero %}{% endblock %}

			<section id="start">
				{% block body %}
					<section id="body-wrapper" class="section-py container-px">
						{% block messages %}
							<div class="container message-spacer">
								{% include 'partials/messages.html.twig' ignore missing %}
							</div>
						{% endblock %}
						<div class="container">
							{{ block('content_surround') }}
						</div>
					</section>
				{% endblock %}
			</section>

			{% block footer %}
				{% include 'partials/bottom-banner.html.twig' %}
			{% endblock %}

			{# Search Overlay #}
			<div id="search-overlay" class="search-overlay" role="dialog" aria-modal="true" aria-label="Search">

				<button id="search-close" class="search-close-button">
					<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewbox="0 0 24 24" stroke-width="2.5" stroke="currentColor" class="icon-xl">
						<path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"/>
					</svg>
					<span class="sr-only">Close search</span>
				</button>

				<div class="search-container" id="search-container">
					<h2 class="search-title desktop-only">Search Resources</h2>
					{% include 'partials/tntsearch.html.twig' %}
					<p class="desktop-only search-hint">Press
						<kbd class="kbd">ESC</kbd>
						to close</p>
				</div>
			</div>
		</div>

		{% block bottom %}
			{{ assets.js('bottom')|raw }}
			{% include 'partials/snipcart.html.twig' %}

			{# Pass theme config to JavaScript #}
			<script id="theme-config" type="application/json">
				{{ theme_js_config|json_encode|raw }}
			</script>
		{% endblock %}
	</body>
</html>
