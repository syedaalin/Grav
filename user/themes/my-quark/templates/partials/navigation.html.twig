{% import 'macros/macros.html.twig' as macros %}
{% import 'macros/nav.html.twig' as nav_macros %}

{# Load Navigation Configuration #}
{% set header_menu = theme_var('agent_header_structure') %}
{% set navigation_config = theme_var('agent_nav_nodes') %}

{% if header_menu %}
    {# Use Header Builder Data #}
    <ul class="cognitive-nav__list">
        {{ nav_macros.loop(header_menu, 1) }}
    </ul>
{% else %}
 <nav class="cognitive-nav" role="navigation" aria-label="Main Navigation">
     {# Existing Logic #}
    <ul class="cognitive-nav__list">
        {% for item in navigation_config %}
            {# STATIC NODES #}
            {% if item.type == 'static_node' %}
                <li class="cognitive-nav__item">
                    <a href="{{ item.route }}" class="cognitive-nav__link">
                        {{ item.title }}
                    </a>
                    {% if item.children %}
                        <ul class="cognitive-nav__sublist">
                            {% for child in item.children %}
                                <li class="cognitive-nav__item">
                                    <a href="{{ child.route }}" class="cognitive-nav__link">
                                        {{ child.title }}
                                    </a>
                                </li>
                            {% endfor %}
                        </ul>
                    {% endif %}
                </li>

            {# SMART NODES #}
            {% elseif item.type == 'smart_node' %}
                <li class="cognitive-nav__item cognitive-nav__item--smart">
                    <span class="cognitive-nav__label">{{ item.title }}</span>
                    <ul class="cognitive-nav__sublist">
                        {# Dynamic Grav Collection Builder #}
                        {% set collection_config = {
                            'items': item.collection_source|default('@root.descendants'),
                            'limit': item.collection_limit|default(5),
                            'order': {'by': 'date', 'dir': 'desc'}
                        } %}
                        
                        {# Apply Filters if configured #}
                        {% if item.collection_type and item.collection_type != 'all' and item.collection_value %}
                             {% set filter_type = item.collection_type == 'type' ? 'template' : item.collection_type %}
                             {% set collection_config = collection_config|merge({'filter': {(filter_type): item.collection_value}}) %}
                        {% endif %}

                        {% set collection = page.collection(collection_config) %}

                        {% for child_page in collection %}
                             <li class="cognitive-nav__item">
                                <a href="{{ child_page.url }}" class="cognitive-nav__link">
                                    {{ child_page.title }}
                                </a>
                            </li>
                        {% endfor %}
                    </ul>
                </li>
            {% endif %}
        {% endfor %}
    </ul>
</nav>

{# Inline styles moved to custom.css for CSP compliance #}
{% endif %}
